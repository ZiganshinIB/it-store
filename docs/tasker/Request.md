# Request - заявка

Предназначен для формирования заявок на основе [шаблонов заявок](./RequestTemplate.md).
## Цель
По заявкам работает группа исполняя или отклоняя ее при необходимости. 

## Поля

| Название         | Тип        | Описание          | Обязательность    | 
|------------------|------------|-------------------|-------------------|
| title            | CharField  | Название          | Обязательное поле |
| description      | TextField  | Описание          | Нет               |
| closed_at        | DateTime   | Дата закрытия     | Нет               |
| dedlin_date      | DateTime   | Крайний срок      | Обязательное поле |
| cansel_date      | DateTime   | Дата завершения   | Нет               |
| author           | ForeignKey | Автор             | Обязательное поле |
| executor         | ForeignKey | Исполнитель       | Нет               |
| group            | ForeignKey | Группа            | Нет               |
| status           | Choice     | Статус            | Обязательное поле |
| request_template | ForeignKey | Шаблон заявки     | Нет               |

## Работа с данными
### Create
Рекомендуется создавать при помощи API запроса. POST запроса.
При создания необходимо указать только поля title, description, request_template

#### Что будет если не указать request_template?
Если не указать шаблон заявки. Заявка будет создана как свободная заявка.
Поля Group будет заполнено по умолчанию. Заявку увидят 1 линия.
Задачи будут пустыми. Согласования тоже не будет.
Статус будет по умолчанию "Новая".

#### Почему нельзя указать список задач? Маршруты согласования?
Это не требуется. Так как заявка создается на основе шаблона заявки. И уже там указывалась все задачи и есть маршрут согласования
Это делается для удобства пользователя (заявителя). Заявитель даже не имеет представление надо ли делать задачи или согласование
Об этом должен заботиться исполнитель заявки.

#### Пример запроса

```json
{
    "title": "Заявка",
    "description": "Тестовое описание",
    "request_template": 1
}
```

### Read
При помощи API запроса. GET запроса по url `/api/v1/tasker/request/`
В зависимости от Группы и Доступов можно получить список заявок
#### Доступы для просмотра всех заявок
Все заявки по умолчанию видны для superuser. 
Но не рекомендуется делать пользователя суперпользователем. 
Это может дать лишние привилегии.

По умолчанию пользователь может просматривать все свои заявки.
Если пользователь author.

Или если пользователь имеет доступ и является STAFF.

| Доступ              | Описание                      |
|---------------------|-------------------------------|
| tasker.view_request | Пользователь видит все заявки |

Или если пользователь является executor. То он видит все заявки за которые он отвечает

Так же можете создать группу заявку смогут просматривать все пользователи, которые имеют группу указанную в поле `group` 

#### Пример ответа от запроса

```json
[
    {
        "id": 1,
        "title": "Заявка",
        "description": "Тестовое описание",
        "closed_at": "2022-01-01T00:00:00Z",
        "dedlin_date": "2022-01-01T00:00:00Z",
        "cansel_date": "2022-01-01T00:00:00Z",
        "author": "user_name",
        "executor": "user_name",
        "status": "new",
        "group": null,
        "request_template": 1,
        "tasks": [
            {
                "id": 1,
                "title": "Задача",
                "description": "Тестовое описание",
                "closed_at": null,
                "dedlin_date": "2022-01-01T00:00:00Z",
                "cansel_date": null,
                "author": "user_name",
                "executor": "user_name",
                "status": "new",
                "group": null,
                "task_template": 1
            }
        ],
        "approvals": [
            {
                "id": 1,
                "title": "Согласование",
                "description": "Тестовое описание",
                "cansel_date": null,
                "author": "user_name",
                "coordinating": "user_name",
                "status": "new"
            }
        ],
        "comments": [
            {
                "id": 1,
                "title": "Комментарий",
                "content": "Тестовый комментарий",
                "author": "user_name",
                "created_at": "2022-01-01T00:00:00Z",
                "updated_at": "2022-01-01T00:00:00Z"
            }
        ]
    }
]
```

### Update

При помощи API запроса. PUT запроса по url `/api/v1/tasker/request/<request_id>/`
В зависимости от Группы и Доступов можно редактировать заявку
#### Доступы для редактирования всех заявок
Все заявки по умолчанию может редактироваться superuser.
Но не рекомендуется делать пользователя суперпользователем. 
Это может дать лишние привилегии.

Также все сотрудники имеющие определенный доступ `tasker.change_request` могут редактировать любую заявку.

Пользователь может редактировать (изменить `title`, `description`, `status` остальные поля от него будут проигнорированы) свою заявку (Если пользователь `author`). 
Но автор заявки не может редактировать тему и описание заявки, если заявка уже находится в работе или отменен или завершен,
то есть имеет статус `prg` или `aprv` или `cans` или `end` или `clos` или `chk`.

* Автор может [отменять свою заявку](#как-отменить-заявку).
* 1 линия может [назначать группу или конкретного исполнителя](#как-назначить-группу-и-исполнителя).
* Член группы или исполнитель [может взять в работу](#как-взять-в-работу-заявку)
* Член группы или исполнитель [может отклонить заявку](#как-отклонить-заявку)
* Член группы или исполнитель [может отправить на проверку заявку](#как-отправить-на-проверку-заявку)
* Автор может [вернуть заявку в работу](#как-вернуть-заявку-в-работу)
##### Как отменить заявку
Автор может менять статус на `cans`, если заявка находится в `aprv`, `new`, `chk`, `prg`.
Или отправить `GET` запрос на url `/api/v1/tasker/request/<request_id>/cansel/`, тогда автоматический пытается отменить заявку.

При отмене заявки статус заявки меняется на `cans`. Приходить оповещение исполнителю заявки `executor`
(Если его нету то не отправиться), будет отправлено оповещение всем пользователям, имеющие группу `group`.
(Если нет группы то не отправиться). Но оповещение в любом случае отправляться сотрудникам с доступом `tasker.change_request`.
Автоматический отменятся все согласования заявки, и задачи, которые были созданы в заявке.

**Обратите внимание**. Если заявка уже была отменена, то ее пользователь не сможет вернуть в работу.
**Обратите внимание**. Если заявка находилась в статусе `chk`, то заявка завершиться примет статус `end`. 

##### Как назначить группу и исполнителя
Если пользователь имеет доступ `tasker.change_request` то может назначить группу или исполнителя,
отправив PUT запрос на url `/api/v1/tasker/request/<request_id>/appoint/` в следующем формате

```json
{
    "group": "group_name",
    "executor": "user_name"
}
```

##### Как взять в работу заявку?
Если является членом группы `group` или исполнитель `executor`, то он может взять в работу заявку.
1. Изменив статус заявки на `prg`
(если статус был `new`, `chk`, `aprv`),
отправив PUT запрос на url `/api/v1/tasker/request/<request_id>/` 
в следующем формате 

    ```json
    {
        "status": "prg"
    }
    ```
2. Или отправив `GET` запрос на url `/api/v1/tasker/request/<request_id>/hire/`,

##### Как отклонить заявку?
Только исполнитель может отклонить заявку.
Если заявка находится в статусе `aprv`, `chk`, `prg`, то исполнитель может ее отклонить.
Для отклонение заявки отправляется `GET` запрос на url `/api/v1/tasker/request/<request_id>/cansel/`

Заявка получить статус `cans` и все согласовании и задачи находящиеся в работе и новые будут отменены.

##### Как отправить на проверку заявку?
Только исполнитель может отправить на проверку заявку.
Если заявка находится в статусе `prg`, то исполнитель может ее отправить на проверку.
Для отправки на проверку заявки отправляется `GET` запрос на url `/api/v1/tasker/request/<request_id>/chk/`

Заявка получить статус `chk` и все согласовании и задачи находящиеся в работе и новые будут отменены

##### Как вернуть заявку в работу?
Только автор может вернуть заявку в работу.
Если заявка находится в статусе `chk`, то автор может ее вернуть в работу.
Для вернуть заявку в работу отправляется `GET` запрос на url `/api/v1/tasker/request/<request_id>/reject/`

Заявка получить статус `prg` и придет оповещение исполнителю, группе и 1-линии(сотрудником с доступом `tasker.change_request`).

### Delete
Удалить заявку можно только пользователем с доступом `tasker.delete_request` и superuser.
Необходимо отправить `DELETE` запрос на url `/api/v1/tasker/request/<request_id>/`

## Рекомендации
- Пользуйтесь явными запросами:
  - Для создания заявки используйте `POST` запрос на url `/api/v1/tasker/request/`
  - Для получения списка заявок используйте `GET` запрос на url `/api/v1/tasker/request/`
  - Для получения конкретной заявки используйте `GET` запрос на url `/api/v1/tasker/request/<request_id>/`
  - Для отмены или завершения заявки используйте `GET` запрос на url `/api/v1/tasker/request/<request_id>/cansel/`
  - Для назначения или изменения группы и исполнителя заявке используйте `PUT` запрос на url `/api/v1/tasker/request/<request_id>/appoint/` 
  - Для взятия в работу заявку используйте `GET` запрос на url `/api/v1/tasker/request/<request_id>/hire/`
  - Для отклонения заявки используйте `GET` запрос на url `/api/v1/tasker/request/<request_id>/cansel/`
  - Для отправки на проверку заявки используйте `GET` запрос на url `/api/v1/tasker/request/<request_id>/chk/`
  - Что бы вернуть заявку в работу используйте `GET` запрос на url `/api/v1/tasker/request/<request_id>/reject/`